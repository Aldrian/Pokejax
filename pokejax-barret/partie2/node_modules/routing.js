"use strict";

/*
 * 2013-09 Nicolas Normand Polytech Nantes
 *
 * Very simple URL routing
 *
 * each route has a regex 're' to match URLs and either a callback function
 * 'cb' to handle the page or a file 'fi' to be delivered.
 */

var fs = require('fs');
var path = require('path');

exports.createRoutingFunction = function createRoutingFunction(routes) {

    return function routeURL(request, response) {
	var i;
	var filePath;
	var stat;

	console.log('URL: %s', request.url);

	// Look for the first matching rule
	for (i = 0; i < routes.length; i++) {
	    if (routes[i].re.test(request.url)) {
		console.log('Matched rule: %s', routes[i].re);

		// Deliver a file...
		if ('fi' in routes[i]) {
		    console.log(routes[i].fi);
		    filePath = path.join(__dirname, routes[i].fi);
		    stat = fs.statSync(filePath);

		    response.writeHead(200, {
			'Content-Type': 'text/html',
			'Content-Length': stat.size
		    });

		    fs.createReadStream(filePath).pipe(response);		
		}
		// ... or call a function
		else if ('cb' in routes[i]) {
		    routes[i].cb.call(undefined, request, response);
		}
		// We shouldn't get there, TODO: throw an exception
		return;
	    }
	};
	response.end();
    }
}
